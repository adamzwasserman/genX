<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GenX Integrated Tagger & Auditor</title>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
        }
        
        .page-content {
            margin-right: 400px;
            padding: 40px;
        }
        
        /* Integrated Panel */
        .gx-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 999999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .gx-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .gx-tabs {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .gx-tab {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .gx-tab.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Audit Score */
        .audit-score {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #0cce6b 0%, #00a651 100%);
            color: white;
        }
        
        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #0cce6b;
        }
        
        .score-details {
            flex: 1;
        }
        
        /* Content Area */
        .gx-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Visual Tagger Styles */
        .gx-element-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .gx-suggestion {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gx-suggestion:hover {
            background: #f8f9fa;
            transform: translateX(4px);
        }
        
        .gx-suggestion.applied {
            background: #d1f4e0;
            border-color: #28a745;
        }
        
        /* Audit Issue Styles */
        .issue-category {
            margin-bottom: 20px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .severity-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .severity-critical { background: #dc3545; }
        .severity-serious { background: #fd7e14; }
        .severity-moderate { background: #ffc107; color: #333; }
        .severity-minor { background: #6c757d; }
        
        .issue-item {
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .issue-item:hover {
            border-color: #667eea;
            transform: translateX(-4px);
        }
        
        /* Manifest Preview */
        .manifest-preview {
            background: #212529;
            color: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre;
        }
        
        /* Action Buttons */
        .gx-actions {
            padding: 16px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 8px;
        }
        
        .gx-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .gx-btn-primary {
            background: #667eea;
            color: white;
        }
        
        .gx-btn-success {
            background: #28a745;
            color: white;
        }
        
        /* Highlights */
        .gx-hovering {
            outline: 2px solid #667eea !important;
            outline-offset: 2px !important;
            cursor: crosshair !important;
        }
        
        .gx-selected {
            outline: 3px solid #28a745 !important;
            outline-offset: 2px !important;
            background: rgba(40, 167, 69, 0.05) !important;
        }
        
        .issue-highlight {
            position: absolute;
            pointer-events: none;
            z-index: 999998;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Sample content -->
    <div class="page-content">
        <h1>Sample E-Commerce Page</h1>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
            <div style="border: 1px solid #ddd; padding: 20px; background: white;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Crect fill='%23e9ecef' width='200' height='150'/%3E%3C/svg%3E" style="width: 100%; height: 150px;">
                <h3>Product Name</h3>
                <div class="price" style="font-size: 24px; font-weight: bold; color: #28a745;">2499.99</div>
                <div class="date" style="color: #6c757d;">Available: 2025-01-20</div>
            </div>
            
            <div style="border: 1px solid #ddd; padding: 20px; background: white;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Crect fill='%23e9ecef' width='200' height='150'/%3E%3C/svg%3E" style="width: 100%; height: 150px;">
                <h3>Another Product</h3>
                <div class="price" style="font-size: 24px; font-weight: bold; color: #28a745;">999.00</div>
                <div class="phone" style="color: #6c757d;">Support: 4155551234</div>
            </div>
        </div>
        
        <form style="background: white; padding: 30px; border: 1px solid #ddd;">
            <h2>Order Form</h2>
            <div style="margin-bottom: 20px;">
                <input type="text" placeholder="Your name" style="width: 100%; padding: 10px;">
            </div>
            <div style="margin-bottom: 20px;">
                <input type="email" placeholder="Email" style="width: 100%; padding: 10px;">
            </div>
            <button type="button" style="background: #007bff; color: white; padding: 10px 20px; border: none;">Submit</button>
        </form>
    </div>
    
    <!-- Integrated Panel -->
    <div class="gx-panel">
        <div class="gx-header">
            <h3 style="margin:0">GenX Tagger & Auditor</h3>
            <div class="gx-tabs">
                <div class="gx-tab active" data-tab="tagger">Visual Tagger</div>
                <div class="gx-tab" data-tab="audit">Accessibility Audit</div>
                <div class="gx-tab" data-tab="manifest">Manifest</div>
            </div>
        </div>
        
        <div id="tab-tagger" class="gx-content">
            <div style="text-align:center; padding:20px; color:#6c757d;">
                Click on any element to see transformation options
            </div>
        </div>
        
        <div id="tab-audit" class="gx-content" style="display:none;">
            <div class="loading">
                <div class="spinner"></div>
                <p>Click "Run Audit" to scan</p>
            </div>
        </div>
        
        <div id="tab-manifest" class="gx-content" style="display:none;">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="stat-transforms">0</div>
                    <div class="stat-label">Transformations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-elements">0</div>
                    <div class="stat-label">Elements</div>
                </div>
            </div>
            <div class="manifest-preview" id="manifest-preview">{
  "transformations": []
}</div>
        </div>
        
        <div class="gx-actions">
            <button class="gx-btn gx-btn-primary" id="btn-action">Run Audit</button>
            <button class="gx-btn gx-btn-success" id="btn-export">Export</button>
        </div>
    </div>
    
    <!-- Load axe-core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.8.2/axe.min.js"></script>
    
    <script>
        class IntegratedTagger {
            constructor() {
                this.mode = 'tagger';
                this.selectedElement = null;
                this.transformations = new Map();
                this.auditResults = null;
                this.highlights = [];
                
                this.init();
            }
            
            init() {
                // Tab switching
                document.querySelectorAll('.gx-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });
                
                // Element interaction
                document.addEventListener('mouseover', (e) => {
                    if (this.mode === 'tagger' && !this.isInPanel(e.target)) {
                        this.highlightElement(e.target);
                    }
                });
                
                document.addEventListener('mouseout', (e) => {
                    if (this.mode === 'tagger' && !this.isInPanel(e.target)) {
                        this.unhighlightElement(e.target);
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (this.mode === 'tagger' && !this.isInPanel(e.target)) {
                        e.preventDefault();
                        this.selectElement(e.target);
                    }
                });
                
                // Action button
                document.getElementById('btn-action').addEventListener('click', () => {
                    if (this.mode === 'audit') {
                        this.runAudit();
                    } else {
                        this.switchTab('audit');
                        this.runAudit();
                    }
                });
                
                document.getElementById('btn-export').addEventListener('click', () => {
                    this.exportManifest();
                });
            }
            
            isInPanel(element) {
                return element.closest('.gx-panel');
            }
            
            switchTab(tab) {
                this.mode = tab;
                
                // Update tabs
                document.querySelectorAll('.gx-tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.tab === tab);
                });
                
                // Update content
                document.querySelectorAll('.gx-content').forEach(c => {
                    c.style.display = 'none';
                });
                document.getElementById(`tab-${tab}`).style.display = 'block';
                
                // Update button
                const btn = document.getElementById('btn-action');
                if (tab === 'audit') {
                    btn.textContent = 'Run Audit';
                    btn.style.display = 'block';
                } else if (tab === 'manifest') {
                    btn.style.display = 'none';
                    this.updateManifest();
                } else {
                    btn.textContent = 'Run Audit';
                    btn.style.display = 'block';
                }
                
                // Clear highlights when switching
                if (tab !== 'audit') {
                    this.clearHighlights();
                }
            }
            
            highlightElement(element) {
                element.classList.add('gx-hovering');
            }
            
            unhighlightElement(element) {
                element.classList.remove('gx-hovering');
            }
            
            selectElement(element) {
                if (this.selectedElement) {
                    this.selectedElement.classList.remove('gx-selected');
                }
                
                this.selectedElement = element;
                element.classList.add('gx-selected');
                
                this.showSuggestions(element);
            }
            
            showSuggestions(element) {
                const suggestions = this.detectSuggestions(element);
                const container = document.getElementById('tab-tagger');
                
                let html = `
                    <div class="gx-element-info">
                        <div style="font-family: monospace; font-size: 12px; color: #495057;">
                            ${this.getSelector(element)}
                        </div>
                    </div>
                `;
                
                if (suggestions.format.length > 0) {
                    html += '<h4>Formatting</h4>';
                    suggestions.format.forEach(s => {
                        html += this.renderSuggestion(element, s, 'format');
                    });
                }
                
                if (suggestions.accessibility.length > 0) {
                    html += '<h4 style="margin-top:16px;">Accessibility</h4>';
                    suggestions.accessibility.forEach(s => {
                        html += this.renderSuggestion(element, s, 'accessibility');
                    });
                }
                
                container.innerHTML = html;
                
                // Attach click handlers
                container.querySelectorAll('.gx-suggestion').forEach(sug => {
                    sug.addEventListener('click', () => this.applySuggestion(sug));
                });
            }
            
            detectSuggestions(element) {
                const suggestions = { format: [], accessibility: [] };
                const text = element.textContent.trim();
                
                // Format detection
                if (/^\d+\.?\d*$/.test(text) && text.length > 2) {
                    suggestions.format.push({
                        label: 'Currency Format',
                        attributes: { 'fx-format': 'currency', 'fx-currency': 'USD' }
                    });
                }
                
                if (/\d{4}-\d{2}-\d{2}/.test(text)) {
                    suggestions.format.push({
                        label: 'Date Format',
                        attributes: { 'fx-format': 'date', 'fx-date-style': 'medium' }
                    });
                }
                
                if (/\d{10,}/.test(text.replace(/\D/g, ''))) {
                    suggestions.format.push({
                        label: 'Phone Format',
                        attributes: { 'fx-format': 'phone', 'fx-country': 'US' }
                    });
                }
                
                // Accessibility detection
                if (element.tagName === 'IMG' && !element.alt) {
                    suggestions.accessibility.push({
                        label: 'Add Alt Text',
                        attributes: { 'ax-enhance': 'image', 'alt': 'Description needed' }
                    });
                }
                
                if (['INPUT', 'SELECT', 'TEXTAREA'].includes(element.tagName) && !element.getAttribute('aria-label')) {
                    suggestions.accessibility.push({
                        label: 'Add Label',
                        attributes: { 'ax-enhance': 'form', 'aria-label': element.placeholder || 'Field label' }
                    });
                }
                
                return suggestions;
            }
            
            renderSuggestion(element, suggestion, type) {
                const id = `sug-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const isApplied = this.isTransformationApplied(element, suggestion);
                
                return `
                    <div class="gx-suggestion ${isApplied ? 'applied' : ''}" 
                         data-element-id="${this.getElementId(element)}"
                         data-suggestion='${JSON.stringify(suggestion)}'>
                        <div style="flex:1">
                            <div style="font-weight:500">${suggestion.label}</div>
                            <div style="font-size:12px; color:#6c757d; margin-top:4px;">
                                ${Object.entries(suggestion.attributes).map(([k,v]) => `${k}="${v}"`).join(' ')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            applySuggestion(suggestionEl) {
                const elementId = suggestionEl.dataset.elementId;
                const suggestion = JSON.parse(suggestionEl.dataset.suggestion);
                const element = document.querySelector(`[data-gx-id="${elementId}"]`);
                
                if (!element) return;
                
                const selector = this.getSelector(element);
                
                if (suggestionEl.classList.contains('applied')) {
                    // Remove
                    const transforms = this.transformations.get(selector);
                    if (transforms) {
                        const index = transforms.findIndex(t => 
                            JSON.stringify(t.attributes) === JSON.stringify(suggestion.attributes));
                        if (index !== -1) transforms.splice(index, 1);
                        if (transforms.length === 0) this.transformations.delete(selector);
                    }
                    suggestionEl.classList.remove('applied');
                } else {
                    // Add
                    if (!this.transformations.has(selector)) {
                        this.transformations.set(selector, []);
                    }
                    this.transformations.get(selector).push(suggestion);
                    suggestionEl.classList.add('applied');
                }
                
                this.updateStats();
            }
            
            async runAudit() {
                const container = document.getElementById('tab-audit');
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Running accessibility audit...</p>
                    </div>
                `;
                
                try {
                    const results = await axe.run(document.querySelector('.page-content'));
                    this.processAuditResults(results);
                } catch (error) {
                    console.error('Audit failed:', error);
                    container.innerHTML = '<div style="padding:20px; color:#dc3545;">Audit failed</div>';
                }
            }
            
            processAuditResults(results) {
                this.auditResults = results;
                const container = document.getElementById('tab-audit');
                
                // Calculate score
                const totalIssues = results.violations.reduce((sum, v) => sum + v.nodes.length, 0);
                const score = Math.max(0, Math.round(100 - (totalIssues / 20 * 100)));
                
                // Group by severity
                const grouped = { critical: [], serious: [], moderate: [], minor: [] };
                results.violations.forEach(v => {
                    grouped[v.impact || 'minor'].push(v);
                });
                
                // Build UI
                let html = `
                    <div class="audit-score">
                        <div class="score-circle">${score}</div>
                        <div class="score-details">
                            <div style="font-size:12px; opacity:0.9;">Accessibility Score</div>
                            <div style="font-size:18px; font-weight:600;">
                                ${score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : score >= 50 ? 'Needs Work' : 'Poor'}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add issues
                Object.entries(grouped).forEach(([severity, violations]) => {
                    if (violations.length > 0) {
                        html += `
                            <div class="issue-category">
                                <div class="category-header">
                                    <span>${severity.charAt(0).toUpperCase() + severity.slice(1)} Issues</span>
                                    <span class="severity-badge severity-${severity}">${violations.length}</span>
                                </div>
                        `;
                        
                        violations.forEach(v => {
                            html += `
                                <div class="issue-item" onclick="tagger.highlightIssue('${v.id}')">
                                    <div style="font-weight:500; margin-bottom:4px;">${v.help}</div>
                                    <div style="font-size:12px; color:#6c757d;">${v.description}</div>
                                    <div style="font-size:11px; color:#999; margin-top:6px;">
                                        ${v.nodes.length} element${v.nodes.length > 1 ? 's' : ''} affected
                                    </div>
                                </div>
                            `;
                            
                            // Auto-add to transformations
                            v.nodes.forEach(node => {
                                const element = document.querySelector(node.target[0]);
                                if (element) {
                                    const selector = node.target[0];
                                    if (!this.transformations.has(selector)) {
                                        this.transformations.set(selector, []);
                                    }
                                    
                                    // Map violation to GenX attributes
                                    let attributes = {};
                                    switch(v.id) {
                                        case 'image-alt':
                                            attributes = { 'ax-enhance': 'image', 'alt': 'Add description' };
                                            break;
                                        case 'label':
                                            attributes = { 'ax-enhance': 'form', 'aria-label': 'Add label' };
                                            break;
                                        default:
                                            attributes = { 'ax-enhance': 'generic', 'ax-fix': v.id };
                                    }
                                    
                                    this.transformations.get(selector).push({
                                        label: v.help,
                                        attributes: attributes,
                                        severity: severity
                                    });
                                }
                            });
                        });
                        
                        html += '</div>';
                    }
                });
                
                container.innerHTML = html;
                this.updateStats();
                this.highlightAllIssues();
            }
            
            highlightIssue(violationId) {
                const violation = this.auditResults.violations.find(v => v.id === violationId);
                if (violation && violation.nodes.length > 0) {
                    const element = document.querySelector(violation.nodes[0].target[0]);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
            
            highlightAllIssues() {
                this.clearHighlights();
                
                if (!this.auditResults) return;
                
                this.auditResults.violations.forEach(v => {
                    v.nodes.forEach(node => {
                        const element = document.querySelector(node.target[0]);
                        if (element) {
                            const rect = element.getBoundingClientRect();
                            const highlight = document.createElement('div');
                            highlight.className = `issue-highlight severity-${v.impact || 'minor'}`;
                            highlight.style.cssText = `
                                position: absolute;
                                left: ${rect.left + window.scrollX}px;
                                top: ${rect.top + window.scrollY}px;
                                width: ${rect.width}px;
                                height: ${rect.height}px;
                                border: 2px solid;
                                border-radius: 4px;
                            `;
                            document.body.appendChild(highlight);
                            this.highlights.push(highlight);
                        }
                    });
                });
            }
            
            clearHighlights() {
                this.highlights.forEach(h => h.remove());
                this.highlights = [];
            }
            
            updateManifest() {
                const manifest = {
                    version: '1.0',
                    generator: 'GenX Integrated Tagger',
                    created: new Date().toISOString(),
                    transformations: []
                };
                
                this.transformations.forEach((transforms, selector) => {
                    transforms.forEach(t => {
                        manifest.transformations.push({
                            selector: selector,
                            attributes: t.attributes,
                            type: t.label,
                            severity: t.severity
                        });
                    });
                });
                
                document.getElementById('manifest-preview').textContent = JSON.stringify(manifest, null, 2);
                this.updateStats();
            }
            
            updateStats() {
                let totalTransforms = 0;
                let totalElements = 0;
                
                this.transformations.forEach(transforms => {
                    totalTransforms += transforms.length;
                    totalElements++;
                });
                
                document.getElementById('stat-transforms').textContent = totalTransforms;
                document.getElementById('stat-elements').textContent = totalElements;
            }
            
            exportManifest() {
                this.switchTab('manifest');
                this.updateManifest();
                
                const manifestText = document.getElementById('manifest-preview').textContent;
                const blob = new Blob([manifestText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `genx-manifest-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            getSelector(element) {
                const path = [];
                let current = element;
                
                while (current && current !== document.body) {
                    let selector = current.tagName.toLowerCase();
                    if (current.id) {
                        selector = `#${current.id}`;
                        path.unshift(selector);
                        break;
                    }
                    if (current.className) {
                        selector += `.${current.className.split(' ').filter(c => !c.startsWith('gx-'))[0]}`;
                    }
                    path.unshift(selector);
                    current = current.parentElement;
                }
                
                return path.slice(-3).join(' > ');
            }
            
            getElementId(element) {
                if (!element.dataset.gxId) {
                    element.dataset.gxId = `gx-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                }
                return element.dataset.gxId;
            }
            
            isTransformationApplied(element, suggestion) {
                const selector = this.getSelector(element);
                const transforms = this.transformations.get(selector);
                return transforms && transforms.some(t => 
                    JSON.stringify(t.attributes) === JSON.stringify(suggestion.attributes));
            }
        }
        
        const tagger = new IntegratedTagger();
    </script>
</body>
</html>
