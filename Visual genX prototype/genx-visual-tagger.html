<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GenX Visual Tagger - Interactive Demo</title>
    <style>
        /* Page content styles */
        body {
            margin: 0;
            padding: 0;
            font-family: Georgia, serif;
            background: #fafafa;
        }
        
        .page-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            margin-right: 340px; /* Make room for overlay */
        }
        
        .page-header {
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-size: 36px;
            margin: 0;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .product-card {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .product-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-price {
            font-size: 24px;
            color: #28a745;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .availability {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .contact-section {
            background: white;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 40px 0;
        }
        
        .contact-section h2 {
            margin-top: 0;
        }
        
        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .info-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        /* Sample form */
        .order-form {
            background: white;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button.order-button {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        

        /* Injected overlay styles */
        .gx-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 999999;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .gx-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .gx-mode-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .gx-mode-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .gx-mode-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .gx-inspector {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .gx-element-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .gx-element-selector {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #495057;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .gx-transformation-group {
            margin-bottom: 16px;
        }

        .gx-group-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #212529;
        }

        .gx-suggestion {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gx-suggestion:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .gx-suggestion.applied {
            background: #d1f4e0;
            border-color: #28a745;
        }

        .gx-suggestion-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gx-preview-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .gx-manifest-section {
            padding: 16px;
            border-top: 1px solid #dee2e6;
        }

        .gx-manifest-preview {
            background: #212529;
            color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre;
        }

        .gx-action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .gx-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gx-btn-primary {
            background: #667eea;
            color: white;
        }

        .gx-btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Highlight system */
        .gx-hovering {
            outline: 2px solid #667eea !important;
            outline-offset: 2px !important;
            cursor: crosshair !important;
        }

        .gx-selected {
            outline: 3px solid #28a745 !important;
            outline-offset: 2px !important;
        }

        .gx-tooltip {
            position: absolute;
            background: #212529;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 999998;
            white-space: nowrap;
        }

        /* Smart detection indicators */
        .gx-confidence-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .gx-confidence-high { background: #28a745; }
        .gx-confidence-medium { background: #ffc107; }
        .gx-confidence-low { background: #dc3545; }
        /* Injected overlay styles */
        .gx-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 999999;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .gx-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .gx-mode-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .gx-mode-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 12px;
        }

        .gx-mode-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .gx-inspector {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .gx-element-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .gx-element-selector {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #495057;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .gx-transformation-group {
            margin-bottom: 16px;
        }

        .gx-group-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #212529;
        }

        .gx-suggestion {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gx-suggestion:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .gx-suggestion.applied {
            background: #d1f4e0;
            border-color: #28a745;
        }

        .gx-suggestion-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gx-preview-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .gx-manifest-section {
            padding: 16px;
            border-top: 1px solid #dee2e6;
            max-height: 300px;
            overflow-y: auto;
        }

        .gx-manifest-preview {
            background: #212529;
            color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre;
        }

        .gx-action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .gx-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 12px;
        }

        .gx-btn-primary {
            background: #667eea;
            color: white;
        }

        .gx-btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Highlight system */
        .gx-hovering {
            outline: 2px solid #667eea !important;
            outline-offset: 2px !important;
            cursor: crosshair !important;
            position: relative;
        }

        .gx-selected {
            outline: 3px solid #28a745 !important;
            outline-offset: 2px !important;
            background: rgba(40, 167, 69, 0.05) !important;
        }

        .gx-tooltip {
            position: absolute;
            background: #212529;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 999998;
            white-space: nowrap;
        }

        /* Smart detection indicators */
        .gx-confidence-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: auto;
        }

        .gx-confidence-high { background: #28a745; }
        .gx-confidence-medium { background: #ffc107; }
        .gx-confidence-low { background: #dc3545; }
    </style>
</head>
<body>
    <!-- Sample page content to tag -->
    <div class="page-content">
        <header class="page-header">
            <h1>Electronics Store Demo</h1>
            <p>Sample e-commerce page with various elements that need formatting and accessibility improvements</p>
        </header>

        <nav>
            <a href="#">Home</a> | 
            <a href="#">Products</a> | 
            <a href="#">About</a> | 
            <a href="#">Contact</a>
        </nav>

        <div class="product-grid">
            <div class="product-card">
                <img class="product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e9ecef' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%236c757d'%3ELaptop%3C/text%3E%3C/svg%3E">
                <div class="product-title">Professional Laptop</div>
                <div class="product-price">2499.99</div>
                <div class="product-description">
                    High-performance laptop with 16GB RAM and 512GB SSD
                </div>
                <div class="availability">Available: 2025-01-20</div>
            </div>

            <div class="product-card">
                <img class="product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e9ecef' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%236c757d'%3EPhone%3C/text%3E%3C/svg%3E">
                <div class="product-title">Smartphone Pro</div>
                <div class="product-price">999.00</div>
                <div class="product-description">
                    Latest model with 5G support and triple camera
                </div>
                <div class="availability">Ships: 2025-01-15</div>
            </div>

            <div class="product-card">
                <img class="product-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e9ecef' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%236c757d'%3ETablet%3C/text%3E%3C/svg%3E">
                <div class="product-title">Digital Tablet</div>
                <div class="product-price">649.99</div>
                <div class="product-description">
                    10-inch display perfect for work and entertainment
                </div>
                <div class="availability">In stock: 2025-01-10</div>
            </div>
        </div>

        <div class="contact-section">
            <h2>Contact Information</h2>
            <div class="contact-info">
                <div class="info-item">
                    <div class="info-label">Phone</div>
                    <div class="info-value phone-number">4155551234</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Support Hours</div>
                    <div class="info-value">9:00 - 17:00</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">support@example.com</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Response Time</div>
                    <div class="info-value">24 hours</div>
                </div>
            </div>
        </div>

        <div class="order-form">
            <h2>Quick Order</h2>
            <form>
                <div class="form-group">
                    <input type="text" placeholder="Your name">
                </div>
                <div class="form-group">
                    <input type="email" placeholder="Email address">
                </div>
                <div class="form-group">
                    <select>
                        <option>Select a product</option>
                        <option>Professional Laptop</option>
                        <option>Smartphone Pro</option>
                        <option>Digital Tablet</option>
                    </select>
                </div>
                <button type="button" class="order-button">Place Order</button>
            </form>
        </div>
    </div>

    <!-- The visual tagger interface will be injected here -->
    
    <script>
        // GenX Visual Tagger - Core Implementation
        (function() {
            'use strict';

            class GenXTagger {
                constructor() {
                    this.mode = 'both'; // format | accessibility | both - DEFAULT TO BOTH
                    this.selectedElement = null;
                    this.transformations = new Map(); // element -> transforms
                    this.overlay = null;
                    this.previewMode = false;
                    
                    // Smart detection patterns
                    this.patterns = {
                        format: {
                            currency: /^\$?[\d,]+\.?\d*$|price|cost|amount|fee|total/i,
                            date: /\d{1,4}[-\/]\d{1,2}[-\/]\d{1,4}|date|time|when|schedule/i,
                            phone: /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}|phone|tel|mobile/i,
                            percent: /\d+\.?\d*\s*%|percent|rate|ratio/i,
                            number: /^[\d,]+\.?\d*$/,
                            email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
                        },
                        accessibility: {
                            navigation: el => el.tagName === 'NAV' || el.role === 'navigation',
                            button: el => el.tagName === 'BUTTON' || el.role === 'button' || 
                                          (el.tagName === 'A' && el.onclick),
                            form: el => ['INPUT', 'SELECT', 'TEXTAREA'].includes(el.tagName),
                            image: el => el.tagName === 'IMG' && !el.alt,
                            heading: el => /^H[1-6]$/.test(el.tagName),
                            list: el => ['UL', 'OL', 'DL'].includes(el.tagName),
                            table: el => el.tagName === 'TABLE'
                        }
                    };
                }

                init() {
                    this.createOverlay();
                    this.attachEventListeners();
                    this.scanPage();
                }

                createOverlay() {
                    const overlay = document.createElement('div');
                    overlay.className = 'gx-overlay';
                    overlay.innerHTML = `
                        <div class="gx-header">
                            <h3 style="margin:0">GenX Visual Tagger</h3>
                            <div class="gx-mode-selector">
                                <button class="gx-mode-btn" data-mode="format">Format</button>
                                <button class="gx-mode-btn" data-mode="accessibility">Accessibility</button>
                                <button class="gx-mode-btn active" data-mode="both">Both</button>
                            </div>
                        </div>
                        
                        <div class="gx-inspector">
                            <div class="gx-instructions" style="text-align:center; color:#6c757d; padding:20px">
                                Click on any element to see transformation options<br>
                                <small style="opacity:0.8">Mode: Both (showing format + accessibility)</small>
                            </div>
                        </div>
                        
                        <div class="gx-preview-toggle">
                            <input type="checkbox" id="gx-preview" />
                            <label for="gx-preview">Live Preview</label>
                        </div>
                        
                        <div class="gx-manifest-section">
                            <div class="gx-group-title">Generated Manifest</div>
                            <div class="gx-manifest-preview">{}</div>
                            <div class="gx-action-buttons">
                                <button class="gx-btn gx-btn-primary" id="gx-copy">Copy Manifest</button>
                                <button class="gx-btn gx-btn-secondary" id="gx-download">Download</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    this.overlay = overlay;
                    
                    // Adjust page width to accommodate overlay
                    document.body.style.marginRight = '320px';
                }

                attachEventListeners() {
                    // Mode switching
                    this.overlay.querySelectorAll('.gx-mode-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            this.setMode(e.target.dataset.mode);
                        });
                    });

                    // Element selection
                    document.addEventListener('mouseover', (e) => {
                        if (e.target !== this.overlay && !this.overlay.contains(e.target)) {
                            this.highlightElement(e.target);
                        }
                    });

                    document.addEventListener('mouseout', (e) => {
                        if (e.target !== this.overlay && !this.overlay.contains(e.target)) {
                            this.unhighlightElement(e.target);
                        }
                    });

                    document.addEventListener('click', (e) => {
                        if (e.target !== this.overlay && !this.overlay.contains(e.target)) {
                            e.preventDefault();
                            e.stopPropagation();
                            this.selectElement(e.target);
                        }
                    });

                    // Preview toggle
                    document.getElementById('gx-preview').addEventListener('change', (e) => {
                        this.togglePreview(e.target.checked);
                    });

                    // Export actions
                    document.getElementById('gx-copy').addEventListener('click', () => {
                        this.copyManifest();
                    });

                    document.getElementById('gx-download').addEventListener('click', () => {
                        this.downloadManifest();
                    });
                }

                setMode(mode) {
                    this.mode = mode;
                    this.overlay.querySelectorAll('.gx-mode-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === mode);
                    });
                    
                    if (this.selectedElement) {
                        this.showSuggestions(this.selectedElement);
                    }
                }

                highlightElement(element) {
                    element.classList.add('gx-hovering');
                    this.showTooltip(element);
                }

                unhighlightElement(element) {
                    element.classList.remove('gx-hovering');
                    this.hideTooltip();
                }

                selectElement(element) {
                    // Clear previous selection
                    if (this.selectedElement) {
                        this.selectedElement.classList.remove('gx-selected');
                    }
                    
                    this.selectedElement = element;
                    element.classList.add('gx-selected');
                    
                    this.showSuggestions(element);
                }

                showSuggestions(element) {
                    const suggestions = this.detectTransformations(element);
                    const inspector = this.overlay.querySelector('.gx-inspector');
                    
                    // Generate robust selector
                    const selector = this.generateSelector(element);
                    
                    let html = `
                        <div class="gx-element-info">
                            <div class="gx-element-selector">${selector}</div>
                            <div style="color:#6c757d; font-size:12px">
                                ${element.tagName.toLowerCase()}
                                ${element.className ? `.${element.className.split(' ').join('.')}` : ''}
                            </div>
                        </div>
                    `;

                    // Format suggestions
                    if (this.mode !== 'accessibility' && suggestions.format.length > 0) {
                        html += `
                            <div class="gx-transformation-group">
                                <div class="gx-group-title">Formatting Options</div>
                                ${suggestions.format.map(s => this.renderSuggestion(element, s, 'format')).join('')}
                            </div>
                        `;
                    }

                    // Accessibility suggestions
                    if (this.mode !== 'format' && suggestions.accessibility.length > 0) {
                        html += `
                            <div class="gx-transformation-group">
                                <div class="gx-group-title">Accessibility Enhancements</div>
                                ${suggestions.accessibility.map(s => this.renderSuggestion(element, s, 'accessibility')).join('')}
                            </div>
                        `;
                    }

                    inspector.innerHTML = html;

                    // Attach click handlers to suggestions
                    inspector.querySelectorAll('.gx-suggestion').forEach(sug => {
                        sug.addEventListener('click', () => this.applySuggestion(sug));
                    });
                    
                    this.updateManifest();
                }

                renderSuggestion(element, suggestion, type) {
                    const isApplied = this.isTransformationApplied(element, suggestion);
                    const icon = type === 'format' ? 'ðŸ’°' : 'â™¿';
                    
                    return `
                        <div class="gx-suggestion ${isApplied ? 'applied' : ''}" 
                             data-element="${this.getElementId(element)}"
                             data-type="${type}"
                             data-transform='${JSON.stringify(suggestion)}'>
                            <div class="gx-suggestion-icon">${icon}</div>
                            <div>
                                <div style="font-weight:500">${suggestion.label}</div>
                                <div style="font-size:12px; color:#6c757d">${suggestion.description}</div>
                            </div>
                            <span class="gx-confidence-indicator gx-confidence-${suggestion.confidence}"></span>
                        </div>
                    `;
                }

                detectTransformations(element) {
                    const suggestions = {
                        format: [],
                        accessibility: []
                    };

                    const text = element.textContent.trim();
                    const classes = element.className;
                    const id = element.id;

                    // Format detection
                    if (this.mode !== 'accessibility') {
                        // Currency
                        if (this.patterns.format.currency.test(text) || 
                            this.patterns.format.currency.test(classes) ||
                            this.patterns.format.currency.test(id)) {
                            suggestions.format.push({
                                label: 'Currency Format',
                                description: 'Format as currency with proper symbols',
                                attributes: { 'fx-format': 'currency', 'fx-currency': 'USD' },
                                confidence: 'high'
                            });
                        }

                        // Date
                        if (this.patterns.format.date.test(text) ||
                            this.patterns.format.date.test(classes)) {
                            suggestions.format.push({
                                label: 'Date Format',
                                description: 'Format as readable date',
                                attributes: { 'fx-format': 'date', 'fx-date-style': 'medium' },
                                confidence: 'high'
                            });
                        }

                        // Phone
                        if (this.patterns.format.phone.test(text)) {
                            suggestions.format.push({
                                label: 'Phone Number',
                                description: 'Format as phone with proper formatting',
                                attributes: { 'fx-format': 'phone', 'fx-country': 'US' },
                                confidence: 'high'
                            });
                        }

                        // Number abbreviation for large numbers
                        if (/^\d{4,}$/.test(text.replace(/,/g, ''))) {
                            suggestions.format.push({
                                label: 'Abbreviate Number',
                                description: 'Display as 1.2K, 3.4M, etc.',
                                attributes: { 'fx-format': 'abbreviated' },
                                confidence: 'medium'
                            });
                        }
                    }

                    // Accessibility detection
                    if (this.mode !== 'format') {
                        // Missing alt text
                        if (element.tagName === 'IMG' && !element.alt) {
                            suggestions.accessibility.push({
                                label: 'Add Alt Text',
                                description: 'Add descriptive alt text for screen readers',
                                attributes: { 'ax-enhance': 'image', 'ax-generate-alt': 'true', 'alt': 'Description needed' },
                                confidence: 'high'
                            });
                        }

                        // Unlabeled form fields
                        if (['INPUT', 'SELECT', 'TEXTAREA'].includes(element.tagName)) {
                            const hasLabel = element.getAttribute('aria-label') || 
                                           element.getAttribute('aria-labelledby') ||
                                           (element.id && document.querySelector(`label[for="${element.id}"]`));
                            if (!hasLabel) {
                                const placeholder = element.getAttribute('placeholder') || 'Field label';
                                suggestions.accessibility.push({
                                    label: 'Add Field Label',
                                    description: 'Add accessible label for form field',
                                    attributes: { 'ax-enhance': 'form', 'ax-label': placeholder, 'aria-label': placeholder },
                                    confidence: 'high'
                                });
                            }
                        }

                        // Navigation enhancement
                        if (element.tagName === 'NAV' || (element.querySelector && element.querySelector('a'))) {
                            suggestions.accessibility.push({
                                label: 'Enhance Navigation',
                                description: 'Add ARIA navigation patterns',
                                attributes: { 'ax-enhance': 'navigation', 'ax-label': 'Main navigation', 'role': 'navigation' },
                                confidence: 'medium'
                            });
                        }

                        // Buttons and clickable elements
                        if (element.tagName === 'BUTTON' || 
                            (element.tagName === 'DIV' && element.onclick) ||
                            element.classList.contains('button') ||
                            element.classList.contains('btn')) {
                            if (!element.getAttribute('aria-label') && !element.textContent.trim()) {
                                suggestions.accessibility.push({
                                    label: 'Add Button Label',
                                    description: 'Add accessible label for button',
                                    attributes: { 'ax-enhance': 'button', 'aria-label': 'Button action' },
                                    confidence: 'high'
                                });
                            }
                            // Make clickable divs accessible
                            if (element.tagName === 'DIV') {
                                suggestions.accessibility.push({
                                    label: 'Make Clickable Element Accessible',
                                    description: 'Add button role and keyboard support',
                                    attributes: { 'ax-enhance': 'clickable', 'role': 'button', 'tabindex': '0' },
                                    confidence: 'high'
                                });
                            }
                        }

                        // Links without descriptive text
                        if (element.tagName === 'A') {
                            const linkText = element.textContent.trim();
                            if (!linkText || linkText.match(/^(click here|here|read more|more)$/i)) {
                                suggestions.accessibility.push({
                                    label: 'Improve Link Text',
                                    description: 'Make link text more descriptive',
                                    attributes: { 'ax-enhance': 'link', 'ax-description': 'true' },
                                    confidence: 'medium'
                                });
                            }
                        }

                        // Headings
                        if (/^H[1-6]$/.test(element.tagName)) {
                            suggestions.accessibility.push({
                                label: 'Mark as Section Heading',
                                description: 'Ensure proper heading hierarchy',
                                attributes: { 'ax-enhance': 'heading', 'ax-level': element.tagName[1] },
                                confidence: 'low'
                            });
                        }

                        // Tables
                        if (element.tagName === 'TABLE') {
                            suggestions.accessibility.push({
                                label: 'Add Table Headers',
                                description: 'Define table headers for screen readers',
                                attributes: { 'ax-enhance': 'table', 'ax-headers': 'true' },
                                confidence: 'high'
                            });
                        }

                        // Lists
                        if (['UL', 'OL'].includes(element.tagName)) {
                            suggestions.accessibility.push({
                                label: 'Enhance List Navigation',
                                description: 'Add list semantics for screen readers',
                                attributes: { 'ax-enhance': 'list', 'role': 'list' },
                                confidence: 'low'
                            });
                        }

                        // Generic divs/spans with text that might be important
                        if ((element.tagName === 'DIV' || element.tagName === 'SPAN') && 
                            element.textContent.trim() && 
                            !element.getAttribute('role')) {
                            // Check if it looks like a label or heading
                            const text = element.textContent.trim();
                            if (text.length < 50 && (text.endsWith(':') || element.style.fontWeight === 'bold')) {
                                suggestions.accessibility.push({
                                    label: 'Add Semantic Role',
                                    description: 'Define the purpose of this element',
                                    attributes: { 'ax-enhance': 'semantic', 'role': 'heading', 'aria-level': '3' },
                                    confidence: 'low'
                                });
                            }
                        }

                        // Skip links for main content areas
                        if (element.tagName === 'MAIN' || 
                            element.id === 'main' || 
                            element.classList.contains('main-content')) {
                            suggestions.accessibility.push({
                                label: 'Add Skip Link Target',
                                description: 'Allow keyboard users to skip to main content',
                                attributes: { 'ax-enhance': 'landmark', 'ax-type': 'main', 'role': 'main' },
                                confidence: 'high'
                            });
                        }
                    }

                    return suggestions;
                }

                generateSelector(element) {
                    // Generate robust, specific selector
                    const path = [];
                    let current = element;
                    
                    while (current && current !== document.body) {
                        let selector = current.tagName.toLowerCase();
                        
                        // Add ID if available (most specific)
                        if (current.id) {
                            selector = `#${current.id}`;
                            path.unshift(selector);
                            break; // ID is unique, can stop here
                        }
                        
                        // Add classes that seem stable (not dynamic)
                        if (current.className && typeof current.className === 'string') {
                            const stableClasses = current.className.split(' ')
                                .filter(c => !c.match(/^(gx-|active|hover|selected|is-|has-)/))
                                .slice(0, 2); // Max 2 classes for readability
                            
                            if (stableClasses.length > 0) {
                                selector += `.${stableClasses.join('.')}`;
                            }
                        }
                        
                        // Add position if needed for uniqueness
                        const siblings = current.parentElement ? 
                            Array.from(current.parentElement.children).filter(c => c.tagName === current.tagName) : [];
                        
                        if (siblings.length > 1) {
                            const index = siblings.indexOf(current) + 1;
                            selector += `:nth-of-type(${index})`;
                        }
                        
                        path.unshift(selector);
                        current = current.parentElement;
                    }
                    
                    // Return a simplified path (last 3 elements usually enough)
                    return path.slice(-3).join(' > ');
                }

                getElementId(element) {
                    // Generate temporary ID for tracking
                    if (!element.dataset.gxId) {
                        element.dataset.gxId = `gx-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    }
                    return element.dataset.gxId;
                }

                applySuggestion(suggestionEl) {
                    const elementId = suggestionEl.dataset.element;
                    const transform = JSON.parse(suggestionEl.dataset.transform);
                    const element = document.querySelector(`[data-gx-id="${elementId}"]`);
                    
                    if (!element) return;

                    // Toggle transformation
                    if (suggestionEl.classList.contains('applied')) {
                        this.removeTransformation(element, transform);
                        suggestionEl.classList.remove('applied');
                    } else {
                        this.addTransformation(element, transform);
                        suggestionEl.classList.add('applied');
                    }
                    
                    if (this.previewMode) {
                        this.applyPreview(element);
                    }
                    
                    this.updateManifest();
                }

                addTransformation(element, transform) {
                    const selector = this.generateSelector(element);
                    
                    if (!this.transformations.has(selector)) {
                        this.transformations.set(selector, []);
                    }
                    
                    this.transformations.get(selector).push(transform);
                }

                removeTransformation(element, transform) {
                    const selector = this.generateSelector(element);
                    const transforms = this.transformations.get(selector);
                    
                    if (transforms) {
                        const index = transforms.findIndex(t => 
                            JSON.stringify(t) === JSON.stringify(transform));
                        if (index !== -1) {
                            transforms.splice(index, 1);
                        }
                        
                        if (transforms.length === 0) {
                            this.transformations.delete(selector);
                        }
                    }
                }

                isTransformationApplied(element, transform) {
                    const selector = this.generateSelector(element);
                    const transforms = this.transformations.get(selector);
                    
                    return transforms && transforms.some(t => 
                        JSON.stringify(t) === JSON.stringify(transform));
                }

                updateManifest() {
                    const manifest = {
                        version: '1.0',
                        generator: 'GenX Visual Tagger',
                        created: new Date().toISOString(),
                        transformations: []
                    };

                    // Convert transformations to manifest format
                    this.transformations.forEach((transforms, selector) => {
                        transforms.forEach(transform => {
                            manifest.transformations.push({
                                selector: selector,
                                attributes: transform.attributes,
                                type: transform.label,
                                confidence: transform.confidence
                            });
                        });
                    });

                    // Update preview
                    const preview = this.overlay.querySelector('.gx-manifest-preview');
                    preview.textContent = JSON.stringify(manifest, null, 2);
                    
                    return manifest;
                }

                copyManifest() {
                    const manifest = this.updateManifest();
                    navigator.clipboard.writeText(JSON.stringify(manifest, null, 2))
                        .then(() => {
                            this.showNotification('Manifest copied to clipboard!');
                        });
                }

                downloadManifest() {
                    const manifest = this.updateManifest();
                    const blob = new Blob([JSON.stringify(manifest, null, 2)], 
                                         { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `genx-manifest-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                togglePreview(enabled) {
                    this.previewMode = enabled;
                    
                    if (enabled) {
                        // Apply all transformations
                        this.transformations.forEach((transforms, selector) => {
                            const elements = document.querySelectorAll(selector);
                            elements.forEach(el => {
                                transforms.forEach(transform => {
                                    Object.entries(transform.attributes).forEach(([key, value]) => {
                                        el.setAttribute(key, value);
                                    });
                                });
                            });
                        });
                        
                        // Load actual GenX libraries if available
                        if (window.formatX) {
                            window.formatX.refresh();
                        }
                        if (window.accessX) {
                            window.accessX.refresh();
                        }
                    } else {
                        // Remove preview attributes
                        this.transformations.forEach((transforms, selector) => {
                            const elements = document.querySelectorAll(selector);
                            elements.forEach(el => {
                                transforms.forEach(transform => {
                                    Object.keys(transform.attributes).forEach(key => {
                                        el.removeAttribute(key);
                                    });
                                });
                            });
                        });
                    }
                }

                showTooltip(element) {
                    const rect = element.getBoundingClientRect();
                    const tooltip = document.createElement('div');
                    tooltip.className = 'gx-tooltip';
                    tooltip.textContent = `${element.tagName.toLowerCase()}`;
                    
                    if (element.className) {
                        tooltip.textContent += `.${element.className.split(' ')[0]}`;
                    }
                    
                    tooltip.style.left = `${rect.left}px`;
                    tooltip.style.top = `${rect.top - 30}px`;
                    tooltip.id = 'gx-active-tooltip';
                    
                    document.body.appendChild(tooltip);
                }

                hideTooltip() {
                    const tooltip = document.getElementById('gx-active-tooltip');
                    if (tooltip) {
                        tooltip.remove();
                    }
                }

                showNotification(message) {
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #28a745;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 4px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        z-index: 1000000;
                        animation: slideIn 0.3s ease;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => notification.remove(), 3000);
                }

                scanPage() {
                    // Auto-detect potential improvements
                    const issues = [];
                    
                    // Find all prices/currency
                    document.querySelectorAll('*').forEach(el => {
                        if (el.children.length === 0) { // Text nodes only
                            const text = el.textContent.trim();
                            if (this.patterns.format.currency.test(text)) {
                                issues.push({ element: el, type: 'currency' });
                            }
                        }
                    });
                    
                    // Find accessibility issues
                    document.querySelectorAll('img:not([alt])').forEach(el => {
                        issues.push({ element: el, type: 'missing-alt' });
                    });
                    
                    console.log(`GenX Tagger: Found ${issues.length} potential improvements`);
                }
            }

            // Initialize
            window.genxTagger = new GenXTagger();
            window.genxTagger.init();
        })();
    </script>
</body>
</html>
